using Microsoft.Win32;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Runtime.InteropServices;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using static VapeGui.Protocol;

namespace VapeGui
{
    public partial class Form1 : Form
    {
        //Coded By Justin\\
        //UI CREDITS: https://www.youtube.com/watch?v=Q-m8NsI9Fhc \\
        //Source Rest of stuff dnspy'd FROM Visenyas GUI\\

        private bool attached;

        // Token: 0x04000239 RID: 569
        private uint attachedID;

        // Token: 0x0400023A RID: 570
        private string visenyaBin = Registry.GetValue("HKEY_CURRENT_USER\\Software\\Visenya", "dir", null).ToString();

        // Token: 0x0400023B RID: 571
        public bool DebugMode;

        // Token: 0x0400023D RID: 573
        private Label Title;
        private delegate void PropagateAttachInfo(bool attach);
        [DllImport("user32.dll", SetLastError = true)]
        internal static extern IntPtr FindWindowA(string lpClassName, string lpWindowName);
        [DllImport("VisenyaInjector.dll")]
        private static extern int injectDLL();
        [DllImport("user32.dll", SetLastError = true)]
        private static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {

        }
        private string AttachError(int code)
        {
            if (code == -57005)
            {
                return "Injector not found.\nPlease check your Anti-Virus and re-run the bootstrapper.";
            }
            switch (code)
            {
                case -6:
                    return "Unsuccessful attach attempt";
                case -5:
                    return "Failed to read module back-end";
                case -4:
                    return "Unable to allocate local memory for module back-end";
                case -3:
                    return "Invalid file size for back-end module";
                case -2:
                    return "Unable to find module.\nPlease check your Anti-Virus and re-run the bootstrapper.";
                case -1:
                    return "Unable to find Roblox Window";
                default:
                    if (this.DebugMode)
                    {
                        return string.Format("Unknown error code {0}.", code.ToString("X"));
                    }
                    return "";
            }
        }
        public void AttachVisenya()
        {
            IntPtr intPtr = Form1.FindWindowA("WINDOWSCLIENT", "Roblox");
            if (!this.attached && intPtr != IntPtr.Zero)
            {
                int num = 0;
                try
                {
                    num = Form1.injectDLL();
                }
                catch (Exception ex)
                {
                    if (ex is DllNotFoundException)
                    {
                        num = -57005;
                    }
                    else if (this.DebugMode)
                    {
                        MessageBox.Show(string.Format("Error in injection: %s", ex.Message), "Debug Output");
                    }
                }
                if (num != 0)
                {
                     string text = this.AttachError(num);
                     if (!string.IsNullOrEmpty(text))
                     {
                       MessageBox.Show(text);
                        return;
                    }
                    
                }
                else
                {
                    GetWindowThreadProcessId(intPtr, out this.attachedID);
                    this.PropertyModification(true);
                    this.attached = true;
                }
            }
        }
        private void PropertyModification(bool attachValue)
        {
            if (this.Status.InvokeRequired)
            {
                PropagateAttachInfo method = new PropagateAttachInfo(this.PropertyModification);
                base.Invoke(method, new object[]
                {
                    attachValue
                });
                return;
            }
            if (attachValue)
            {
                this.Status.Text = "Online";
                this.Status.ForeColor = Color.Lime;
                this.Status.Enabled = false;
                this.Status.Enabled = true;
                return;
            }
            this.Status.Text = "Offline";
            this.Status.ForeColor = Color.Red;
            this.Status.Enabled = true;
            this.Status.Enabled = false;
        }
        private void velyseForm1_Click(object sender, EventArgs e)
        {

        }

        private void velyseButton1_Click(object sender, EventArgs e)
        {
            
            IPC.Execute(textBox1.Text);
        }

        private void velyseButton4_Click(object sender, EventArgs e)
        {
                new Thread(new ThreadStart(this.AttachVisenya)).Start();
        }

        private void velyseButton3_Click(object sender, EventArgs e)
        {
            IPC.Execute("saveinstance()");
        }

        private void velyseButton2_Click(object sender, EventArgs e)
        {
            textBox1.Text = "";
            textBox1.Refresh();
        }
    }
}
